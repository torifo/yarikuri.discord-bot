# Yarikuri Discord Bot - 次期開発ToDoリスト

## 概要
レシート解析システムの編集機能実装完了後の次期開発計画。主にデバッグ、コマンド完全実装、データ永続化、API連携機能を中心とした開発項目をリストアップ。

## Phase 1: 現在実装機能のデバッグ・改善

### 1.1 レシート解析システムのデバッグ
- [ ] 確認画面の表示テスト
  - [ ] 各編集ボタンの動作確認
  - [ ] モーダル表示・送信の動作確認
  - [ ] セレクトメニューの選択動作確認
- [ ] データ整合性のテスト
  - [ ] 複数ユーザー同時使用時の動作確認
  - [ ] メモリリークの確認
  - [ ] エラーハンドリングの改善
- [ ] UI/UXの改善
  - [ ] エラーメッセージの日本語化
  - [ ] ユーザーフィードバックの改善
  - [ ] 確認画面のレイアウト調整

### 1.2 パフォーマンス最適化
- [ ] AI解析処理の高速化
- [ ] メモリ使用量の最適化
- [ ] Discord APIの応答時間改善
- [ ] 並行処理の安全性確認

## Phase 2: 既存コマンドの完全実装

### 2.1 `/add` コマンドの完全実装
- [ ] 手動データ入力機能の完全実装
  - [ ] カテゴリー選択の改善
  - [ ] グループ選択機能の追加
  - [ ] 支払い方法選択の実装
  - [ ] 入力値検証の強化
- [ ] データ保存処理の実装
  - [ ] バリデーション機能の追加
  - [ ] 重複チェック機能
  - [ ] エラー時のロールバック

### 2.2 `/fix` コマンドの完全実装
- [ ] キューデータの検索機能
  - [ ] キーワード検索の実装
  - [ ] 部分一致検索
  - [ ] 日付範囲検索
  - [ ] カテゴリー別検索
- [ ] データ修正機能
  - [ ] 検索結果表示の改善
  - [ ] インライン編集機能
  - [ ] 一括修正機能
- [ ] 削除・復元機能
  - [ ] 論理削除の実装
  - [ ] 削除確認ダイアログ
  - [ ] 削除履歴の保持

## Phase 3: データ永続化システム

### 3.1 JSON形式キューシステム
- [ ] キューファイル管理システム
  ```go
  type QueueItem struct {
      ID          string    `json:"id"`
      UserID      int       `json:"user_id"`
      Date        string    `json:"date"`
      Amount      int       `json:"amount"`
      CategoryID  int       `json:"category_id"`
      GroupID     *int      `json:"group_id,omitempty"`
      PaymentMethod string  `json:"payment_method"`
      Detail      string    `json:"detail"`
      Status      string    `json:"status"` // pending, processing, completed, error
      CreatedAt   time.Time `json:"created_at"`
      UpdatedAt   time.Time `json:"updated_at"`
  }
  ```
- [ ] ファイルI/O操作の実装
  - [ ] 安全な書き込み処理（原子性確保）
  - [ ] ファイルロック機能
  - [ ] バックアップ機能
- [ ] キューデータの管理
  - [ ] ステータス管理（pending, processing, completed, error）
  - [ ] 自動クリーンアップ機能
  - [ ] データ整合性チェック

### 3.2 データ構造の設計
- [ ] 統一データモデルの定義
- [ ] JSON Schema の作成
- [ ] バージョニング機能
- [ ] マイグレーション機能

## Phase 4: ローカルAPI連携システム

### 4.1 Gin API サーバー連携
- [ ] HTTP クライアント実装
  ```go
  type APIClient struct {
      BaseURL    string
      HTTPClient *http.Client
      APIKey     string
  }
  ```
- [ ] エンドポイント設計
  - [ ] `POST /api/expenses` - 支出データ送信
  - [ ] `GET /api/expenses/status/{id}` - 処理状況確認
  - [ ] `POST /api/expenses/batch` - 一括送信
- [ ] 認証・セキュリティ
  - [ ] API Key認証
  - [ ] リクエスト署名
  - [ ] リトライ機能

### 4.2 データ送信システム
- [ ] 非同期送信機能
  - [ ] ワーカープール実装
  - [ ] バッチ処理機能
  - [ ] エラー時の再送機能
- [ ] 送信ステータス管理
  - [ ] 送信履歴の記録
  - [ ] 失敗時のアラート
  - [ ] 手動再送機能

### 4.3 ローカル環境設定
- [ ] 設定ファイルの拡張
  ```bash
  # .env ファイルへの追加項目
  API_ENDPOINT=http://localhost:8080
  API_KEY=your_api_key_here
  BATCH_SIZE=10
  RETRY_COUNT=3
  TIMEOUT_SECONDS=30
  ```
- [ ] 環境別設定
  - [ ] 開発環境設定
  - [ ] テスト環境設定
  - [ ] 本番環境設定

## Phase 5: 運用・監視機能

### 5.1 ログ・監視システム
- [ ] 構造化ログの実装
- [ ] メトリクス収集
- [ ] ヘルスチェック機能
- [ ] アラート機能

### 5.2 管理機能
- [ ] キュー状況確認コマンド
- [ ] システム状態確認コマンド
- [ ] データ統計表示機能
- [ ] バックアップ・リストア機能

## 実装優先度

### 高優先度（即座に着手）
1. レシート解析システムのデバッグ
2. JSON形式キューシステムの基本実装
3. `/add` コマンドの完全実装

### 中優先度（Phase 1完了後）
1. ローカルAPI連携システム
2. `/fix` コマンドの完全実装
3. データ送信システム

### 低優先度（機能拡充フェーズ）
1. 運用・監視機能
2. パフォーマンス最適化
3. 管理機能

## 技術スタック

### バックエンド
- **Discord Bot**: Go + discordgo
- **API Server**: Go + Gin
- **データ形式**: JSON
- **ファイルシステム**: ローカルファイル

### 開発ツール
- **ビルド**: Go標準ツール
- **デプロイ**: systemd
- **監視**: journald + 独自ログ
- **テスト**: Go標準testing

## 開発予定期間

- **Phase 1**: 1-2週間（デバッグ・改善）
- **Phase 2**: 2-3週間（コマンド実装）
- **Phase 3**: 1-2週間（データ永続化）
- **Phase 4**: 2-3週間（API連携）
- **Phase 5**: 1週間（運用機能）

**合計予定期間**: 7-11週間

## 成功指標

### 機能面
- [ ] レシート解析から最終データ保存まで一気通貫で動作
- [ ] 手動入力機能が完全に動作
- [ ] データ修正機能が完全に動作
- [ ] API連携が安定して動作

### 非機能面
- [ ] 99%以上の稼働率
- [ ] 3秒以内の応答時間
- [ ] データロスゼロ
- [ ] メモリ使用量 < 500MB

## リスク・課題

### 技術リスク
- Discord API制限への対応
- Go言語の学習コスト
- Gin API との連携複雑性

### 運用リスク
- データ損失の可能性
- システム障害時の復旧
- API側の仕様変更

### 対策
- 十分なテストの実施
- バックアップ機能の実装
- エラーハンドリングの強化
- ドキュメントの充実

---

**最終更新**: 2025-08-24
**ステータス**: Phase 1 開始準備完了