# Yarikuri Discord Bot - 動作確認マニュアル

## 概要

本文書は、家計管理Discord Bot「yarikuri_bot」の全機能における動作確認手順とテストケースを詳細に定義します。リファクタリング後の品質保証と運用安定性の確保を目的としています。

## テスト環境要件

### 必須環境
- **Go**: 1.21以上
- **Discord Bot Token**: テスト用専用トークン
- **Gemini API Key**: Google AI Studio API Key
- **PostgreSQL**: マスターデータ確認用（オプション）

### 環境変数設定
```bash
# .env ファイル例
DISCORD_TOKEN=your_test_bot_token_here
TARGET_CHANNEL_ID=your_test_channel_id
GEMINI_API_KEY=your_gemini_api_key_here
```

### テストデータ準備
- レシート画像サンプル: [`img/`](img/) ディレクトリ内の画像ファイル
- 詳細データサンプル: [`detail_samples/`](detail_samples/) ディレクトリ内のテキストファイル

## 1. 初期化・起動テスト

### 1.1 ビルドテスト
```bash
cd bot
go build -v .
```

**期待結果**: エラーなしでビルド完了

**確認項目**:
- [ ] コンパイルエラーなし
- [ ] 警告メッセージなし
- [ ] 実行ファイル生成確認

### 1.2 依存関係テスト
```bash
go mod tidy
go mod verify
```

**期待結果**: 依存関係の整合性確認

### 1.3 起動テスト
```bash
./yarikuri_bot
```

**期待結果**: 
```
Bot起動完了
Discord接続完了
マスターデータ読み込み完了: X件
```

**確認項目**:
- [ ] Discord接続成功ログ
- [ ] マスターデータ読み込み成功ログ
- [ ] エラーメッセージなし

## 2. Discord API接続テスト

### 2.1 基本接続テスト
**手順**:
1. Botをテストサーバーに招待
2. 指定チャンネルでのBot応答確認

**確認項目**:
- [ ] Botがオンライン状態
- [ ] スラッシュコマンドが表示される
- [ ] Bot権限が適切に設定されている

### 2.2 スラッシュコマンド登録テスト
**コマンド一覧**:
- `/add` - レシート追加
- `/list` - データ一覧表示
- `/manage` - マスターデータ管理
- `/help` - ヘルプ表示

**確認項目**:
- [ ] 全コマンドがDiscord上で認識される
- [ ] コマンド説明文が正しく表示される
- [ ] 必須パラメータが適切に設定されている

## 3. レシート解析機能テスト

### 3.1 画像アップロード・基本解析テスト

#### テストケース 3.1.1: 標準的なレシート
**手順**:
1. `/add` コマンド実行
2. [`img/20250818_134533.jpg`](img/20250818_134533.jpg) をアップロード
3. AI解析結果を確認

**期待結果**:
- 店舗名の正確な認識
- 商品名・価格の適切な抽出
- 合計金額の正確性
- 日付の正しい解析

**確認項目**:
- [ ] 解析開始メッセージ表示
- [ ] 3秒以内の初回応答
- [ ] Gemini APIからの応答受信
- [ ] 構造化データの生成
- [ ] エラーハンドリング動作

#### テストケース 3.1.2: 複雑なレシート（多品目）
**手順**:
1. `/add` コマンド実行  
2. [`img/20250819_185003.jpg`](img/20250819_185003.jpg) をアップロード
3. 多品目解析結果を確認

**期待結果**:
- 複数商品の個別認識
- 価格と商品の正確な対応
- 割引・税込み価格の処理

#### テストケース 3.1.3: 不鮮明な画像
**手順**:
1. 低画質またはブレた画像をアップロード
2. エラーハンドリングの確認

**期待結果**:
- 適切なエラーメッセージ表示
- 再アップロード促進メッセージ
- システムクラッシュなし

### 3.2 AI解析タイムアウト処理テスト

#### テストケース 3.2.1: 3秒制限対応
**手順**:
1. 大容量画像でAI解析を実行
2. Discord 3秒制限への対応確認

**期待結果**:
- 「解析中です...」メッセージの即座表示
- バックグラウンドでの継続処理
- 結果の後続メッセージでの提供

**確認項目**:
- [ ] Interaction応答 < 3秒
- [ ] 解析継続の通知
- [ ] 最終結果の適切な表示
- [ ] タイムアウトエラーなし

### 3.3 AI解析結果の検証テスト

#### テストケース 3.3.1: 解析精度の評価
**手順**:
1. 既知の正解データがあるレシートで解析実行
2. 抽出データと正解の比較

**精度指標**:
- 店舗名認識率: > 90%
- 商品名認識率: > 85%  
- 価格認識率: > 95%
- 日付認識率: > 98%

**確認項目**:
- [ ] 文字認識の正確性
- [ ] 数値抽出の精度
- [ ] 日本語処理の品質
- [ ] 構造化データの整合性

## 4. マスターデータ管理テスト

### 4.1 データ読み込みテスト

#### テストケース 4.1.1: 初期データ読み込み
**手順**:
1. Bot起動時のマスターデータ読み込み確認
2. ログでの読み込み件数確認

**期待結果**:
- カテゴリ、グループ、決済方法等の読み込み成功
- 適切な件数のログ表示
- データ整合性の確認

**確認項目**:
- [ ] 全テーブルデータの読み込み
- [ ] 重複データの除外
- [ ] 関連データの整合性
- [ ] エラーハンドリング

### 4.2 データ管理UI テスト

#### テストケース 4.2.1: マスターデータ一覧表示
**手順**:
1. `/manage` コマンド実行
2. 各種マスターデータの一覧表示確認

**期待結果**:
- カテゴリ一覧の正確な表示
- ページネーション機能
- ソート機能の動作

#### テストケース 4.2.2: データ追加・編集
**手順**:
1. 新規カテゴリ追加操作
2. 既存データの編集操作
3. キュー機能での変更管理確認

**期待結果**:
- スムーズなモーダル表示
- 入力検証の動作
- キューへの適切な追加

### 4.3 キューシステムテスト

#### テストケース 4.3.1: キュー追加・表示
**手順**:
1. マスターデータ変更を複数件実行
2. キュー一覧での表示確認
3. キュー処理順序の確認

**期待結果**:
- 変更内容の正確な記録
- FIFO（先入先出）順序での処理
- [`queue.json`](queue.json) ファイルの整合性

#### テストケース 4.3.2: キュー処理・適用
**手順**:
1. 蓄積されたキューの一括処理実行
2. マスターデータへの反映確認
3. キューのクリア確認

**期待結果**:
- 全キューアイテムの正常処理
- データ更新の反映
- 処理後のキューファイルクリア

## 5. インタラクション処理テスト

### 5.1 ボタンインタラクション

#### テストケース 5.1.1: 基本ボタン操作
**手順**:
1. レシート解析後の確認・編集ボタンをテスト
2. 各ボタンの応答確認

**確認項目**:
- [ ] ボタンクリック応答速度
- [ ] 適切なモーダル表示
- [ ] CustomIDの正確な処理
- [ ] 状態管理の継続性

### 5.2 モーダルインタラクション

#### テストケース 5.2.1: データ入力モーダル
**手順**:
1. レシート編集モーダルを開く
2. 各フィールドでの入力テスト
3. バリデーション機能の確認

**期待結果**:
- 入力フィールドの正確な表示
- リアルタイムバリデーション
- エラーメッセージの適切な表示

**確認項目**:
- [ ] 数値フィールドの入力制限
- [ ] 日付形式の検証
- [ ] 必須項目の検証
- [ ] 文字数制限の動作

### 5.3 セレクトメニューインタラクション

#### テストケース 5.3.1: カテゴリ選択
**手順**:
1. カテゴリ選択セレクトメニューを開く
2. 選択肢の表示確認
3. 選択処理の動作確認

**期待結果**:
- マスターデータからの正確な選択肢生成
- 日本語ソート機能の動作
- 選択値の適切な処理

## 6. データ永続化テスト

### 6.1 JSONファイル操作テスト

#### テストケース 6.1.1: キューファイル操作
**手順**:
1. キューデータの追加・更新
2. [`queue.json`](queue.json) ファイルの内容確認
3. ファイル読み込み・書き込みの確認

**期待結果**:
- JSON構造の正確性
- ファイルロック機能の動作
- データ整合性の保持

**確認項目**:
- [ ] 同時アクセス時の競合回避
- [ ] ファイル破損の防止
- [ ] エンコーディング（UTF-8）の正確性

### 6.2 画像ファイル管理テスト

#### テストケース 6.2.1: 一時画像処理
**手順**:
1. Discord画像の一時保存確認
2. [`img/`](img/) ディレクトリでの画像管理
3. 処理後のクリーンアップ確認

**期待結果**:
- 画像の正確なダウンロード
- 適切な一時ファイル名生成
- メモリリークの防止

## 7. エラーハンドリング・例外テスト

### 7.1 ネットワーク例外テスト

#### テストケース 7.1.1: Discord API障害
**手順**:
1. ネットワーク切断状態でのBot動作
2. API制限到達時の動作
3. 復旧時の自動再接続確認

**期待結果**:
- 適切なエラーログ出力
- ユーザーへの分かりやすいエラーメッセージ
- 自動復旧機能の動作

#### テストケース 7.1.2: Gemini API障害
**手順**:
1. Gemini API Key無効時の処理
2. API Rate Limit到達時の処理
3. レスポンスタイムアウト時の処理

**期待結果**:
- エラーの適切な分類と処理
- フォールバック機能の動作
- ユーザーへの代替手段提示

### 7.2 データ例外テスト

#### テストケース 7.2.1: 不正データ処理
**手順**:
1. 破損したJSONファイルでの起動
2. 不正な画像ファイルのアップロード
3. 異常な入力値での処理

**期待結果**:
- データバリデーション機能の動作
- 適切なデフォルト値の適用
- システムクラッシュの回避

## 8. パフォーマンステスト

### 8.1 応答時間テスト

#### テストケース 8.1.1: Discord応答時間
**手順**:
1. 各種コマンドの応答時間測定
2. 連続実行時のパフォーマンス確認

**性能要件**:
- 初回応答時間: < 3秒（Discord制限）
- 平均応答時間: < 2秒
- 99%ile応答時間: < 5秒

#### テストケース 8.1.2: AI解析時間
**手順**:
1. 標準的なレシート画像での解析時間測定
2. 様々なサイズの画像での性能確認

**性能要件**:
- 標準レシート（< 2MB): < 10秒
- 大容量画像（2-5MB): < 20秒
- タイムアウト: 30秒

### 8.2 同時実行テスト

#### テストケース 8.2.1: 複数ユーザー同時利用
**手順**:
1. 複数のDiscordアカウントでの同時利用
2. 状態管理の分離確認
3. パフォーマンス劣化の測定

**期待結果**:
- ユーザー間状態の完全分離
- 応答時間の大幅な劣化なし
- メモリ使用量の適切な管理

### 8.3 メモリ・リソーステスト

#### テストケース 8.3.1: メモリリーク確認
**手順**:
1. 長時間稼働でのメモリ使用量監視
2. 大量データ処理時のリソース使用確認

**監視指標**:
- 初期メモリ使用量: < 100MB
- 1時間稼働後: < 150MB
- メモリリーク検出: なし

## 9. セキュリティテスト

### 9.1 入力値検証テスト

#### テストケース 9.1.1: 悪意のある入力
**手順**:
1. SQLインジェクション攻撃的な入力値
2. XSS攻撃的な入力値
3. 長すぎる文字列の入力

**期待結果**:
- 全ての悪意のある入力の適切な拒否
- システムへの影響なし
- ログでの攻撃検知

### 9.2 権限制御テスト

#### テストケース 9.2.1: Discord権限確認
**手順**:
1. Bot権限の最小権限設定確認
2. 管理者権限なしでの動作確認

**確認項目**:
- [ ] 必要最小限の権限のみ利用
- [ ] 不適切な権限昇格なし
- [ ] Discord API権限の適切な使用

## 10. 互換性テスト

### 10.1 Go バージョン互換性
**テスト対象バージョン**:
- Go 1.21.x
- Go 1.22.x（最新安定版）

### 10.2 依存ライブラリ互換性
**確認項目**:
- [ ] `github.com/bwmarrin/discordgo` 最新版
- [ ] `google.golang.org/genai` 最新版
- [ ] その他依存関係の最新対応

### 10.3 OS互換性テスト
**対象OS**:
- Ubuntu 20.04 LTS
- Ubuntu 22.04 LTS
- CentOS 8

## 11. 運用監視テスト

### 11.1 ログ出力テスト

#### テストケース 11.1.1: ログ形式・内容確認
**手順**:
1. 全機能実行時のログ出力確認
2. ログレベルの適切性確認
3. ログローテーション動作確認

**期待されるログ要素**:
- タイムスタンプ
- ログレベル
- 機能識別子
- エラー詳細（該当時）
- トレーサビリティ情報

### 11.2 システム監視テスト

#### テストケース 11.2.1: ヘルスチェック機能
**手順**:
1. Bot生存状況の確認方法
2. 異常検知時のアラート動作
3. 復旧処理の自動実行

**確認項目**:
- [ ] Discord接続状態の監視
- [ ] Gemini API接続状態の監視
- [ ] プロセス監視の動作

## 12. バックアップ・復旧テスト

### 12.1 データバックアップテスト

#### テストケース 12.1.1: キューデータバックアップ
**手順**:
1. [`queue.json`](queue.json) の定期バックアップ設定
2. データ損失シミュレーション
3. バックアップからの復旧確認

### 12.2 災害復旧テスト

#### テストケース 12.2.1: システム再構築
**手順**:
1. 完全なシステム停止シミュレーション
2. ゼロからの環境再構築
3. データ復旧とサービス再開

**復旧時間目標**:
- 環境再構築: < 30分
- データ復旧: < 10分
- サービス再開: < 45分

## 13. ユーザビリティテスト

### 13.1 UI/UX テスト

#### テストケース 13.1.1: 新規ユーザー体験
**手順**:
1. 初回利用ユーザーでの操作性確認
2. ヘルプ機能の分かりやすさ
3. エラー時の案内の適切性

#### テストケース 13.1.2: 日本語対応
**手順**:
1. 日本語入力・表示の正確性
2. 文字化け・表示崩れの確認
3. Unicode処理の確認

**確認項目**:
- [ ] 日本語入力の適切な処理
- [ ] ソート機能での日本語対応
- [ ] エラーメッセージの日本語化

### 13.2 アクセシビリティテスト

#### テストケース 13.2.1: Discordアクセシビリティ
**手順**:
1. スクリーンリーダーでの操作性
2. キーボードナビゲーション
3. 色覚多様性への配慮

## 14. 自動化テストスクリプト

### 14.1 単体テストスクリプト

```bash
#!/bin/bash
# テスト実行スクリプト

echo "=== yarikuri Bot 自動テスト開始 ==="

# ビルドテスト
echo "1. ビルドテスト"
cd bot
go build -v .
if [ $? -eq 0 ]; then
    echo "✓ ビルド成功"
else
    echo "✗ ビルド失敗"
    exit 1
fi

# 静的解析
echo "2. 静的解析"
go vet ./...
if [ $? -eq 0 ]; then
    echo "✓ go vet 成功"
else
    echo "✗ go vet 失敗"
fi

# レースコンディション検査
echo "3. レースコンディション検査"
go build -race .
if [ $? -eq 0 ]; then
    echo "✓ レースコンディション検査成功"
else
    echo "✗ レースコンディション検査失敗"
fi

# 依存関係チェック
echo "4. 依存関係チェック"
go mod tidy
go mod verify
if [ $? -eq 0 ]; then
    echo "✓ 依存関係チェック成功"
else
    echo "✗ 依存関係チェック失敗"
fi

echo "=== 自動テスト完了 ==="
```

### 14.2 統合テストスクリプト

```bash
#!/bin/bash
# 統合テスト実行スクリプト

echo "=== yarikuri Bot 統合テスト開始 ==="

# 環境変数チェック
if [ -z "$DISCORD_TOKEN" ] || [ -z "$GEMINI_API_KEY" ]; then
    echo "✗ 必須環境変数が設定されていません"
    echo "DISCORD_TOKEN および GEMINI_API_KEY を設定してください"
    exit 1
fi

# テスト用Bot起動
echo "1. テスト用Bot起動"
./yarikuri_bot &
BOT_PID=$!
sleep 5

# Bot生存確認
if ps -p $BOT_PID > /dev/null; then
    echo "✓ Bot起動成功"
else
    echo "✗ Bot起動失敗"
    exit 1
fi

# ヘルスチェック
echo "2. ヘルスチェック"
# Discord接続確認ログチェック
if grep -q "Discord接続完了" bot.log; then
    echo "✓ Discord接続成功"
else
    echo "✗ Discord接続失敗"
fi

# Gemini API接続確認
if grep -q "Gemini API初期化完了" bot.log; then
    echo "✓ Gemini API接続成功"
else
    echo "✗ Gemini API接続失敗"
fi

# テスト終了
echo "3. テスト終了処理"
kill $BOT_PID
wait $BOT_PID 2>/dev/null

echo "=== 統合テスト完了 ==="
```

## パフォーマンスベンチマーク

### ベンチマーク指標
- **Discord応答時間**: 平均 < 2秒, 99%ile < 5秒
- **AI解析時間**: 標準レシート < 10秒
- **メモリ使用量**: 初期 < 100MB, 稼働中 < 150MB
- **CPU使用率**: 平均 < 10%, 解析時 < 50%

### 測定方法
```bash
# メモリ使用量監視
while true; do
    ps aux | grep yarikuri_bot | grep -v grep
    sleep 10
done

# 応答時間測定（Discord API）
time curl -X POST "https://discord.com/api/v10/applications/{app_id}/commands" \
  -H "Authorization: Bot $DISCORD_TOKEN" \
  -H "Content-Type: application/json"
```

## 次のアクション

### 実行前チェックリスト
- [ ] `.env` ファイルの環境変数設定完了
- [ ] テスト用Discordサーバー・チャンネル準備完了
- [ ] レシート画像サンプル準備完了
- [ ] 自動テストスクリプトの実行権限設定完了

### テスト実行順序
1. **自動化テスト実行** (約5分)
2. **手動機能テスト実行** (約30分)
3. **パフォーマンステスト実行** (約15分)
4. **例外・エラーハンドリングテスト** (約20分)
5. **総合評価・レポート作成** (約10分)

### 合格基準
- **Critical問題**: 0件
- **High問題**: 0件
- **Medium問題**: < 3件
- **テスト通過率**: > 95%
- **パフォーマンス指標**: 全て基準内

---

**作成日**: 2025-08-30  
**バージョン**: 1.0  
**ステータス**: テスト実行待ち